---
Title: R formula syntax
---

# Goals

- review R formula syntax including some lesser known shortcuts
- be able to identify possible random effect grouping structures
- be able to write out random effect formulas for `lme4::lmer()` in multiple ways
- be able to convert `lme4::lmer()` random effect syntax to `nlme::lme()` syntax

# Formula syntax

What is a shorthand way of writing the following?

```{r}
y ~ x1 + x2 + x3 + x4 + x1:x2 + x2:x3 + x1:x3 + x1:x4 + x2:x4 + x3:x4
```

Answer:

```{r}
y ~ (x1 + x2 + x3 + x4)^2
```

What does the following simplify to?

```{r}
y ~ x1 + x1 + x1*x2
```

Answer:

```{r}
y ~ x1*x2
```

Are the following the same? Why or why not?

```{r}
y ~ x^2
y ~ I(x^2)
```

# Random effect syntax

A group of grad students are trying to model log(frog density) as a function of soil characteristics. What might their model look like in the following cases (using lmer)?

Jerry measures frog density and soil characteristics from 1 transect within 6 separate ponds.

```{r}
log(frog_dens) ~ soil + (1 | pond)
log(frog_dens) ~ soil + (1 + soil | pond)
log(frog_dens) ~ soil + (soil | pond)
```

Emily measures frog density and soil characteristics from 5 transects within 1 pond.

```{r}
log(frog_dens) ~ soil + (1 | transect)
log(frog_dens) ~ soil + (1 + soil | transect)
log(frog_dens) ~ soil + (soil | transect)
```

Jane measures frog density and soil characteristics from 5 transects (`transect`) within 6 ponds (`pond`). Assume her data are structured like this:

```{r}
set.seed(99)
d <- tibble(
  frog_dens = rlnorm(100), 
  soil = rnorm(100), 
  pond = gl(25, 4), # generates factor levels
  transect = rep(gl(2, 2), 25),
  transect2 = gl(50, 2)) # ignore transect2 for now
d
```

What is one way she could write the model with a random intercept?

```{r}
log(frog_dens) ~ soil + (1 | pond/transect)
```

What's another way to write the same model?

```{r}
log(frog_dens) ~ soil + (1 | pond) + (1 | pond:transect)
```

What if she had coded her transects as in the `transect2` column? She could write her model the same way as above with `transect`, but she has one new option. What is that?

```{r}
log(frog_dens) ~ soil + (1 | pond) + (1 | transect2)
```

Let's paste those into `lmer()` for proof that they are the same:

```{r}
library(lme4)
(m1 <- lmer(log(frog_dens) ~ soil + (1 | pond/transect), data = d))
(m2 <- lmer(log(frog_dens) ~ soil + (1 | pond) + (1 | transect:pond), data = d))
(m4 <- lmer(log(frog_dens) ~ soil + (1 | pond) + (1 | transect2), data = d))
```

But the following *is not* the same, and is probably *not* what you want to do. Why is that? What does this one mean?

```{r}
(m_wrong <- lmer(log(frog_dens) ~ soil + (1 | pond) + (1 | transect), data = d))
```

For practice, how can we write the following model using `nlme::lme()` syntax?

lme4:

```{r}
(m_lmer <- lmer(log(frog_dens) ~ soil + (1 | pond/transect), data = d))
```

nlme:

```{r}
(m_nlme <- nlme::lme(log(frog_dens) ~ soil, random =  ~ 1 | pond/transect, data = d))
```

Compare the output. Are they the same?
